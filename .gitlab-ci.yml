stages:
  - build
  - end-to-end-tests
  - deploy

variables:
  HTTP_PORT: 8080
  HTTPS_PORT: 8081
  DOMAIN: ""
  MYSQL_USER: user
  MYSQL_PASSWORD: password
  MYSQL_ROOT_PASSWORD: rootpassword
  MYSQL_DATABASE: kanclOnline
  CYPRESS_baseUrl: http://app:$8080

build:
  stage: build
  image: maven:3.8.6-openjdk-11
  script:
    - mvn test
    - mvn package
  artifacts:
    untracked: false
    expire_in: 1 day
    paths:
      - target/server-1.0-SNAPSHOT.jar

end-to-end-tests:
  stage: end-to-end-tests

  services:
    - name: app
      alias: app
      command:
        - echo "Creating Database"
        - /scripts/prepare-maria-db.sh
        - echo "Starting Caddy server"
        - rm /etc/caddy/Caddyfile
        - cp run/Caddyfile /etc/caddy/Caddyfile
        - caddy run --config /etc/caddy/Caddyfile --adapter caddyfile &
        - echo "Starting Java application"
      entrypoint:
        - java -jar target/server-1.0-SNAPSHOT.jar

  image:
    name: cypress/included:10.3.0
    entrypoint: [""]

  script:
    - cp -r test/* /test
    - cd /test
    - cypress run

deploy:
  stage: deploy
  script:
    - echo "This job deploys something from the $CI_COMMIT_BRANCH branch."